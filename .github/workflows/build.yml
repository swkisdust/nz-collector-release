name: Release

on:
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: true
      matrix:
        arch: [aarch64, arm, armhf, i686, loongarch64, mips64el, mipsel, ppc, ppc64, ppc64le, riscv64, x86_64]
      
    runs-on: ubuntu-latest
    env:
      ARCH: ${{ matrix.arch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download toolchains
        run: |
          bash .github/download.sh

      - name: Install libprotobuf-c
        run: |
          export PLATFORM=$(echo $TOOLCHAIN_NAME | sed 's/-\(native\|cross\)//')
          wget https://github.com/protobuf-c/protobuf-c/releases/download/v1.5.0/protobuf-c-1.5.0.tar.gz
          tar -zxf protobuf-c-1.5.0.tar.gz
          cd ./protobuf-c-1.5.0
          ./configure --disable-shared --enable-static --disable-protoc --disable-largefile --prefix=/opt/toolchains/${TOOLCHAIN_NAME} --host=${PLATFORM}
          make -j${nproc}
          sudo PATH=$PATH make install
      
      - name: Build collector
        run: |
          git clone https://git.kuzu.uk/nz-collector.git/
          cd nz-collector
          echo "VERSION=$(git describe --tags `git rev-list --tags --max-count=1`)" >> $GITHUB_ENV
          mkdir build && cd build
          cmake -DCMAKE_TOOLCHAIN_FILE=../../cmake/${{ matrix.arch }}_musl.cmake -DENABLE_STATIC=1 ..
          make
          mv collector collector_${{ matrix.arch }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nz-collector_${{ matrix.arch }}
          path: |
            ./nz-collector/build/collector_${{ matrix.arch }}

      - name: Upload assets to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          files: |
            ./nz-collector/build/collector_${{ matrix.arch }}


          